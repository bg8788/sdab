<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SADABEFY Movies (Fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:Arial, sans-serif; background:#0f0f0f; color:#fff; }
    header { background:#1c1c1c; padding:15px; text-align:center; border-bottom:2px solid #222; }
    header h1 { margin:0; color:#FFD700; font-size:20px; }

    .status { text-align:center; padding:10px 0; color:#bbb; font-size:14px; }
    .search-bar { display:flex; justify-content:center; margin:12px 10px; }
    .search-bar input { width:72%; padding:10px; border:none; border-radius:6px 0 0 6px; outline:none; font-size:14px; background:#171717; color:#fff; border:1px solid #222; }
    .search-bar button { padding:10px 14px; border:none; background:#fdd835; color:#000; font-weight:bold; cursor:pointer; border-radius:0 6px 6px 0; }

    .categories { display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:14px auto; padding:0 10px; }
    .categories button { padding:8px 14px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; color:#fff; font-size:13px; background:#2d2d2d; transition:transform .15s; }
    .categories button:hover { transform:scale(1.05); }
    .categories button.active { background:#FFD700 !important; color:#000; }

    .movies { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:18px; padding:18px; }
    .movie-card { background:#1e1e1e; border-radius:10px; overflow:hidden; position:relative; cursor:pointer; transition:transform .18s, box-shadow .18s; min-height:260px; }
    .movie-card:hover { transform:translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.6); }
    .movie-card img { width:100%; height:260px; object-fit:cover; display:block; background:#222; }
    .movie-card .tag { position:absolute; top:10px; right:10px; background:#e74c3c; padding:6px 9px; font-size:12px; border-radius:5px; font-weight:700; }
    .star { position:absolute; top:10px; left:10px; color:#FFD700; font-size:18px; text-shadow:0 0 5px #000; }
    .movie-info { padding:10px; }
    .movie-info h4 { margin:6px 0 4px 0; font-size:15px; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .movie-info p { margin:0; font-size:13px; color:#bdbdbd; }

    .no-msg { text-align:center; padding:40px; color:#bbb; grid-column: 1/-1; }

    @media (max-width:520px){
      .movie-card img { height:200px; }
      .search-bar input { width:60%; }
    }
  </style>
</head>
<body>

  <header>
    <h1>ðŸŽ¬ SADABEFY MOVIES</h1>
  </header>

  <div class="status" id="status">Connecting to database...</div>

  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search movies by title...">
    <button id="searchBtn">Search</button>
  </div>

  <div class="categories" id="categories">
    <button data-cat="Bollywood">Bollywood</button>
    <button data-cat="Hollywood">Hollywood</button>
    <button data-cat="South">South</button>
    <button data-cat="Anime">Anime</button>
    <button data-cat="Trending">Trending</button>
  </div>

  <div class="movies" id="moviesGrid"></div>

  <script type="module">
    // ---------- FIREBASE (module) ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzTaPIpIDRmzRgPDw9lmAVaM6Rwx4VIy0",
      authDomain: "sadabefy.firebaseapp.com",
      databaseURL: "https://sadabefy-default-rtdb.firebaseio.com",
      projectId: "sadabefy",
      storageBucket: "sadabefy.appspot.com",
      messagingSenderId: "891450651440",
      appId: "1:891450651440:web:113acea137e2cd5db6cef5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI refs
    const moviesGrid = document.getElementById('moviesGrid');
    const statusEl = document.getElementById('status');
    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const categoryButtons = document.querySelectorAll('#categories button');

    let moviesList = []; // array of {id, ...data}
    let activeCategory = null;

    // useful placeholder
    const PLACEHOLDER_IMG = 'https://via.placeholder.com/400x260?text=No+Image';

    // realtime listener
    const moviesRef = ref(db, 'movies');
    onValue(moviesRef, (snapshot) => {
      console.log('[Firebase] movies snapshot:', snapshot.exists() ? snapshot.val() : null);
      if (!snapshot.exists()) {
        moviesList = [];
        moviesGrid.innerHTML = '<div class="no-msg">No movies found. Admin panel se publish karo.</div>';
        statusEl.textContent = 'No movies available';
        return;
      }

      // convert object -> array and reverse so newest first
      const obj = snapshot.val();
      moviesList = Object.entries(obj).map(([id, data]) => ({ id, ...data }));
      moviesList.reverse();

      statusEl.textContent = '';
      renderMovies();
    }, (err) => {
      console.error('Firebase onValue error', err);
      statusEl.textContent = 'Error fetching movies â€” check console';
      moviesGrid.innerHTML = `<div class="no-msg">Failed to load movies. See console for error.</div>`;
    });

    // render with current filter/search
    function renderMovies() {
      moviesGrid.innerHTML = '';
      const q = (searchInput.value || '').trim().toLowerCase();
      let shown = 0;

      moviesList.forEach(movie => {
        // safety defaults
        const title = (movie.title || '').toString();
        const poster = movie.posterUrl || movie.image || PLACEHOLDER_IMG;
        const imdb = movie.imdbRating || movie.tag || '';
        const language = (movie.language || '').toString();
        const categoriesField = Array.isArray(movie.categories) ? movie.categories.join(' ') : (movie.categories || '');
        // combined text for category matching
        const catText = (language + ' ' + categoriesField + ' ' + (movie.title||'')).toLowerCase();

        // filtering
        if (q && !title.toLowerCase().includes(q)) return;
        if (activeCategory && !catText.includes(activeCategory.toLowerCase())) return;

        // card
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.title = title;

        const img = document.createElement('img');
        img.src = poster;
        img.alt = title;
        img.addEventListener('error', () => { img.src = PLACEHOLDER_IMG; });

        const star = document.createElement('span'); star.className = 'star'; star.textContent = 'â˜…';
        const tag = document.createElement('span'); tag.className = 'tag'; tag.textContent = imdb || 'WEB-DL';

        const info = document.createElement('div'); info.className = 'movie-info';
        const h4 = document.createElement('h4'); h4.textContent = title || 'Untitled';
        const p = document.createElement('p'); p.textContent = language || (movie.releaseDate ? new Date(movie.releaseDate).getFullYear() : '');

        info.appendChild(h4); info.appendChild(p);

        card.appendChild(star); card.appendChild(tag); card.appendChild(img); card.appendChild(info);

        // click -> open download page with id
        card.addEventListener('click', () => {
          if (!movie.id) {
            console.warn('movie missing id', movie);
            return;
          }
          window.location.href = `download.html?id=${encodeURIComponent(movie.id)}`;
        });

        moviesGrid.appendChild(card);
        shown++;
      });

      if (shown === 0) {
        moviesGrid.innerHTML = '<div class="no-msg">No movies match your search / category.</div>';
      }
    }

    // category buttons behaviour
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        // toggle (click again to clear)
        if (btn.classList.contains('active')) {
          btn.classList.remove('active');
          activeCategory = null;
        } else {
          categoryButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeCategory = btn.dataset.cat || btn.textContent.trim();
        }
        renderMovies();
      });
    });

    // search
    searchBtn.addEventListener('click', renderMovies);
    searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') renderMovies(); });

    // debug helper: show instructions in console
    console.log('Index.js loaded â€” if movies not showing: 1) open Console, 2) check "Firebase onValue" logs, 3) ensure files served via http(s) not file://, 4) check RTDB rules.');
  </script>

</body>
</html>